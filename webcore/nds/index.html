<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
        <link rel="manifest" href="manifest.json" />
        <link rel="apple-touch-icon" href="icon.png" />
        <link rel="preload" href="audio-worklet.js" as="script" />
        <link href="dark.css" rel="stylesheet" />
        <title>DS Player</title>
        <style>
             body {
                overflow-x: hidden;
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
                cursor: inherit;
                background-color: black;
                color: white;
                padding: 0;
                margin: 0;
                width: 100vw;
                height: 100vh;
                font-family: 'Myriad Set Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            }

            select {
                margin-right: 6px;
                margin-bottom: 6px;
                border: 2px solid #ffffff;
                border-radius: 6px;
                padding: 10px;
                color: #dbdbdb;
                background-color: #161f27;
                font-family: system-ui, -apple-system, sans-serif;
                font-size: inherit;
                box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.25);
            }

            canvas {
            	position: absolute;
            	z-index: 1;
            	image-rendering: pixelated;
            }

            #msg-layer {
                position: absolute;
                left: 0;
                width: 100%;
                top: 40vh;
                background: rgba(0, 0, 0, 0.1);
                z-index: 3;
                backdrop-filter: blur(1.5px);
                -webkit-backdrop-filter: blur(1.5px);
            }

            #vk-layer {
            	position: absolute;
            	left: 0;
            	top: 0;
            	width: 100%
            	height: 100%;
            	z-index: 2;
            	touch-action: none;
            }

            #menu {
            	position: absolute;
            	left: 0;
            	top: 0;
            	width: 100%;
            	height: 100%;
            	z-index: 4;
            	overflow: hidden scroll;
            	background: rgba(0, 0, 0, 0.35);
            	backdrop-filter: blur(2.5px);
                           -webkit-backdrop-filter: blur(2.5px);
            }

            #menu button {
            	background: transparent;
            }

            #menu button:active {
            	background: rgba(255, 255, 255, 0.5);
            }

            a,
            a:visited {
            	color: white;
            }

            .vk-trig {
            	text-align: center;
            	vertical-align: middle;
            	display: inline-block;
            	border-radius: 10% / 25% !important;
            }

            .vk-square {
            	text-align: center;
            	vertical-align: middle;
            	display: inline-block;
            	border-radius: 15% !important;
            }

            .vk-rectangle {
            	text-align: center;
            	vertical-align: middle;
            	display: inline-block;
            	border-radius: 5% / 10% !important;
            }

            .vk-round {
            	text-align: center;
            	vertical-align: right;
            	border-radius: 50% !important;
            	display: inline-block;
            }

            .vk {
            	color: rgba(0, 0, 0, 0.15);
            	background-color: rgba(255, 255, 255, 0.25);
            	position: absolute;
            	z-index: 1;
            	box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.25);
            	text-align: center;
            	vertical-align: middle;
            	border-radius: 0%;
            	display: inline-block;
            }

            .vk-touched {
            	background-color: rgba(255, 255, 255, 0.75) !important;
            }

            .link {
            	text-decoration: none;
                font-weight: italic;
            }
        </style>
    </head>
    <body>
        <div id="welcome" class="menu">
            <button class="button" style="float: right; margin-top: 5px; margin-right: 20px; height: 50px;" onclick="uiSwitchTo('menu');">Settings</button>
            <h1 style="margin-top: 25px; margin-left: 20px;">DS Player</h1>
            <div style="margin-left: 20px;" id="loading">Loading...</div>
            <div id="loadrom" hidden>
                <input id="rom" type="file" hidden />
                <button style="width: calc(100% - 2em); margin: 1em" id="btn-choose-file">Choose File (or drag/drop)...</button>
                <br />
            </div>
            <!--
	    <p style="color: #e7e7e7; margin-left: 15px;">This software should not be used to play games you have not legally obtained. In no way is this site associated with any of the vendors of the original game software and hardware.<br /></p>
	    -->
            <hr />
            <div id="pro" style="background-color: #333"></div>
            <div id="ios-hint" hidden style="margin-left: 14px; bottom: 7px;">
		<p>Due to iOS Safari limitations, you have to add this page to your <b>Home Screen</b> in order to save your game progress.</p>
            </div>
            <div id="mac-warning" hidden>
                WARNING:
                <br />
                It looks like you are using macOS. <br />
                Due to macOS Safari <a href="https://webkit.org/tracking-prevention/">limitations</a>, ALL of you save data will be LOST after 7 days of inactivity. <br />
                For this reason, it is highly recommended to use a different browser. (For example: <a href="https://www.google.com/chrome/">Chrome</a>)
            </div>
        </div>
        <div id="vk-layer" hidden>
            <div class="vk-rectangle vk" data-k="menu" id="vk-menu">Menu</div>
            <div class="vk-trig vk" data-k="l">L</div>
            <div class="vk-trig vk" data-k="r">R</div>
            <div class="vk-round vk" data-k="a">A</div>
            <div class="vk-round vk" data-k="b">B</div>
            <div class="vk-round vk" data-k="x">X</div>
            <div class="vk-round vk" data-k="y">Y</div>
            <div class="vk-square vk" data-k="select">-</div>
            <div class="vk-square vk" data-k="start">+</div>
            <div class="vk-round vk" data-k="stick" id="vk-stick"></div>
            <div class="vk-rectangle vk" data-k="mic">Mic</div>
        </div>
        <div style="z-index: 2; position: absolute; bottom: 7px; right: 7px;" id="fps"></div>
        <div id="msg-layer" hidden>
            <p id="msg-text"></p>
        </div>
        <div id="menu" hidden>
            <button id="back-menu" style="margin-top: 5px; margin-right: 5px;" onclick="uiMenuBack();">Back</button>
            <button style="margin-top: 5px; margin-right: 5px;" onclick="runFunctions()">Enter Fullscreen</button>
            <hr />
            <input type="checkbox" id="cfg-opt" style="margin-left: 7px;" />
            <label for="cfg-opt">Experimental optimization</label>
            <br />
            <input type="checkbox" id="power-save" style="margin-left: 7px;" />
            <label for="power-save">Power-save</label>
            <br />
            <input type="checkbox" id="vk-enabled" style="margin-left: 7px;" />
            <label for="vk-enabled">Virtual keyboard</label>
            <br />
            <label for="screen-layout" style="margin-left: 7px;">Screen Layout:</label>
            <select id="screen-layout" class="select">
                <option value="tb">T:B (Top:Bottom)</option>
                <option value="lr">L:R (Left:Right)</option>
                <option value="lbr">LB:R (LeftBig:Right)</option>
            </select>
            <hr />
            <div style="position: fixed; bottom: 0; left: 0; padding: 10px;">
                <a href="../gba" style="font-size: 12px;">GBA Player</a>
            </div>
            <!--
	    <div style="position: fixed; bottom: 0; right: 0; padding: 10px;"><span style="font-size: 12px;">Version 0.1 | </span><a onclick="whatsNew()" href="#" style="font-size: 12px;">What's New</a></div>
	    -->
            <div style="margin-left: 7px;" id="menu-savegame" hidden>
                <input type="file" id="restore-file" onchange="uiSaveRestore()" hidden />Save Data:
                <button onclick="uiSaveBackup()">Export</button>
                <button onclick="$id('restore-file').click()">Import</button>
                <hr />
            </div>
            <a style="margin-left: 7px;" href="#" id="a-gamepad">Gamepad Disconnected</a>
        </div>
        <div id="player" hidden>
            <canvas id="top" width="256" height="192"></canvas>
            <canvas id="bottom" width="256" height="192"></canvas>
        </div>
        <script src="localforage.js"></script>
        <script src="pako.min.js"></script>
        <script src="app.js"></script>
        <script>
            var jsFile = "build/nds.js";
            if (localStorage) {
                if (localStorage['simd'] == "1") {
                    jsFile = "build-simd/nds.js";
                }
            }
            var script = document.createElement('script');
            script.src = jsFile;
            document.body.appendChild(script);
        </script>
        <script src="sw-loader.js"></script>
        <script>
            function openLink(url) {
            	window.open(url, '_blank');
            }
        </script>
        <script>
            // Menu trigger function
            var gamepadIndex = 0; // Change this value if you have multiple gamepads connected
            var isTriggerPressed = false;
            var isWaiting = false;

            window.addEventListener("gamepadconnected", function (e) {
            	console.log("Gamepad connected!");
            });

            function gamepadLoop() {
            	var gamepad = navigator.getGamepads()[gamepadIndex];
            	if (gamepad) {
            		var currentState = gamepad.buttons[6].pressed;
            		if (currentState && !isTriggerPressed && !isWaiting) {
            			isTriggerPressed = true;
            			setTimeout(function () {
            				if (gamepad.buttons[6].pressed) {
            					if (document.getElementById("menu").style.display === "block") {
            						uiMenuBack();
            					} else {
            						uiSwitchTo("menu");
            					}
            				}
            				isTriggerPressed = false;
            				isWaiting = true;
            				setTimeout(function () {
            					isWaiting = false;
            				}, 500);
            			}, 500);
            		}
            	}
            	requestAnimationFrame(gamepadLoop);
            }

            requestAnimationFrame(gamepadLoop);
        </script>
        <script>
            var screenLayout = 'tb';
            document.addEventListener('DOMContentLoaded', function () {
            	document.getElementById('screen-layout').addEventListener('change', function () {
            		screenLayout = this.value;
            		updateScreenLayout();
            	});

            	function updateScreenLayout() {
            		var topCanvas = document.getElementById('top');
            		var bottomCanvas = document.getElementById('bottom');

            		if (screenLayout === 'lbr') {
            			const canvasWidthBig = window.innerWidth * 0.75;
            			const canvasHeightBig = canvasWidthBig * 0.75;
            			const canvasWidthSmall = window.innerWidth * 0.25;
            			const canvasHeightSmall = canvasWidthSmall * 0.75;

            			topCanvas.style.position = 'absolute';
            			topCanvas.style.top = '0';
            			topCanvas.style.left = '0';
            			topCanvas.style.width = `${canvasWidthBig}px`;
            			topCanvas.style.height = `${canvasHeightBig}px`;
            			bottomCanvas.style.position = 'absolute';
            			bottomCanvas.style.top = '0';
            			bottomCanvas.style.left = '75%';
            			bottomCanvas.style.width = `${canvasWidthSmall}px`;
            			bottomCanvas.style.height = `${canvasHeightSmall}px`;
            		} else if (screenLayout === 'lr') {
            			const canvasWidth = window.innerWidth * 0.5;
            			const canvasHeight = canvasWidth * 0.75;

            			topCanvas.style.position = 'absolute';
            			topCanvas.style.top = '0';
            			topCanvas.style.left = '0';
            			topCanvas.style.width = `${canvasWidth}px`;
            			topCanvas.style.height = `${canvasHeight}px`;
            			bottomCanvas.style.position = 'absolute';
            			bottomCanvas.style.top = '0';
            			bottomCanvas.style.left = '50%';
            			bottomCanvas.style.width = `${canvasWidth}px`;
            			bottomCanvas.style.height = `${canvasHeight}px`;
            		} else {
            			topCanvas.style.left = '25%';
            			topCanvas.style.width = '75vh';
            			topCanvas.style.height = '50vh';
            			bottomsCanvas.style.top = '50vh';
            			bottomCanvas.style.left = '25%';
            			bottomCanvas.style.width = '75vh';
            			bottomCanvas.style.height = '50vh';
            		}
            	}

            	// Call the updateScreenLayout function initially to set the default layout
            	updateScreenLayout();
            });
        </script>
    </body>
</html>
